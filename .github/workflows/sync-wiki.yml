name: Sync Repo Docs to Wiki

on:
  push:
    branches:
      - main
      - master
    paths:
      - "**/*.md"
      - "scripts/**"
      - "config/**"
      - "output/**"
      - "install.sh"
      - ".github/workflows/sync-wiki.yml"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync repo documentation to wiki
        run: |
          # Sync any docs stored under docs/ (if present) to the wiki, preserving structure.
          # If docs/ is absent, skip gracefully (avoids failing when the folder is not used).

          if [ -d "docs" ]; then
            rsync -av --delete docs/ wiki-repo/
          else
            echo "No docs/ folder found, skipping docs sync"
          fi

          cd wiki-repo

          # Mark newly created wiki pages as auto-generated
          NEW_FILES=$(git ls-files --others --exclude-standard)
          for f in $NEW_FILES; do
            case "$f" in
              *.md)
                NOTE="<!-- Auto-generated by sync-wiki workflow. Do not edit directly. -->"
                if ! head -n 1 "$f" | grep -q "Auto-generated by sync-wiki"; then
                  tmpfile=$(mktemp)
                  { echo "$NOTE"; echo ""; cat "$f"; } > "$tmpfile"
                  mv "$tmpfile" "$f"
                fi
                ;;
            esac
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --staged --quiet; then
            echo "No changes to sync"
          else
            git commit -m "Sync wiki from main repository"
            git push origin master
          fi
