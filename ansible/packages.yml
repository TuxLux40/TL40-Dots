---
- name: Install CLI and GUI packages on Arch
  hosts: all
  become: true
  gather_facts: false

  vars:
    official_pkgs_cli:
      - aircrack-ng
      - arpwatch
      - atuin
      - bcg729
      - borg
      - borgmatic
      - ccid
      - chezmoi
      - composer
      - davfs2
      - debtap
      - dma
      - flawfinder
      - gpg-tui
      - grim
      - gum
      - hardinfo2
      - hwloc
      - iperf3
      - java-environment-common
      - java-runtime-common
      - jdk-openjdk
      - kismet
      - libev
      - libluv
      - libutf8proc
      - libvterm
      - libwebsockets
      - libzip
      - lksctp-tools
      - lnav
      - lua53
      - lua51-lpeg
      - mariadb-libs
      - maven
      - metasploit
      - msgpack-c
      - namcap
      - nbtscan
      - net-tools
      - nikto
      - nmap
      - pcsc-perl
      - pcsc-tools
      - perl-json
      - perl-mime-charset
      - perl-net-ssleay
      - perl-unicode-linebreak
      - perl-yaml-tiny
      - php
      - po4a
      - postgresql-libs
      - promtail
      - python-boolean.py
      - python-configobj
      - python-distlib
      - python-dulwich
      - python-fastbencode
      - python-license-expression
      - python-merge3
      - python-msgpack
      - python-patiencediff
      - python-pyelftools
      - python-pyserial
      - python-pyscard
      - python-pyusb
      - python-virtualenv
      - python-websockets
      - python-yubico
      - qt5-base
      - qt5-translations
      - ranger
      - reaver
      - rpmextract
      - ruby
      - ruby-bundler
      - rubygems
      - samba
      - sbctl
      - scrcpy
      - shellcheck
      - slurp
      - sniffnet
      - stack
      - starship
      - step-ca
      - step-cli
      - superfile
      - sysbench
      - tcpdump
      - tcpflow
      - termshark
      - testdisk
      - tree-sitter
      - tree-sitter-c
      - tree-sitter-lua
      - tree-sitter-markdown
      - tree-sitter-query
      - tree-sitter-vim
      - tree-sitter-vimdoc
      - tui-journal
      - uv
      - ventoy-bin
      - veracrypt
      - wireguard-tools
      - wireshark-cli
      - wiki-tui
      - wireless_tools
      - yt-dlp
      - yubico-c
      - yubico-c-client
      - yubico-pam
      - yubikey-manager
      - yubikey-personalization
      - yubikey-personalization-gui
      - yubikey-touch-detector

    aur_pkgs_cli: []

    official_pkgs_gui:
      - gimp
      - gnome-boxes
      - gparted
      - libreoffice-fresh
      - lmms
      - mousepad
      - mpv
      - obs-studio
      - qalculate-gtk
      - retroarch
      - seahorse
      - shotcut
      - steam
      - vlc
      - vlc-plugins-extra

    aur_pkgs_gui:
      - android-file-transfer
      - audacity
      - ausweisapp2
      - brave-beta-bin
      - brave-bin
      - discord
      - digikam
      - dotnet-sdk-8.0
      - dotnet-sdk-bin
      - emudeck
      - filezilla
      - ghostty
      - github-desktop-bin
      - gnac
      - google-chrome
      - impala
      - jellyfin-ffmpeg
      - jellyfin-media-player
      - masterpdfeditor-free
      - microsoft-edge-stable-bin
      - mission-center
      - obs-studio-stable
      - octopi
      - openrgb
      - paperwork
      - pdfarranger
      - php-imagick
      - podman-desktop
      - powershell-editor-services
      - proton-mail-bin
      - proton-pass-bin
      - protonmail-bridge
      - qemu-emulators-full
      - redshift
      - refind
      - refind-btrfs
      - rpi-imager
      - scratch
      - signal-desktop-beta
      - spytrap-adb
      - surge-xt
      - sweethome3d
      - ttf-meslo-nerd-font-powerlevel10k
      - visual-studio-code-bin
      - yubico-authenticator-bin
      - zed

  tasks:
    - name: Ensure pacman database is up to date
      community.general.pacman:
        update_cache: true
      tags: [cli, gui]

    - name: Install CLI official packages
      community.general.pacman:
        name: "{{ item }}"
        state: present
        extra_args: --needed
      loop: "{{ official_pkgs_cli }}"
      tags: [cli]

    - name: Install GUI official packages
      community.general.pacman:
        name: "{{ item }}"
        state: present
        extra_args: --needed
      loop: "{{ official_pkgs_gui }}"
      tags: [gui]

    - name: Check if obs-studio is installed
      ansible.builtin.command: pacman -Q obs-studio
      register: obs_studio_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Check if obs-studio-stable is installed
      ansible.builtin.command: pacman -Q obs-studio-stable
      register: obs_studio_stable_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Check if dotnet-host is installed
      ansible.builtin.command: pacman -Q dotnet-host
      register: dotnet_host_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Install AUR packages (CLI)
      ansible.builtin.command: "paru -S --noconfirm --needed {{ item }}"
      args:
        warn: false
      loop: "{{ aur_pkgs_cli }}"
      register: aur_cli_results
      changed_when: "aur_cli_results.rc == 0"
      failed_when: false
      tags: [cli]

    - name: Install AUR packages (GUI)
      ansible.builtin.command: "paru -S --noconfirm --needed {{ item }}"
      args:
        warn: false
      loop: "{{ aur_pkgs_gui }}"
      register: aur_gui_results
      changed_when: "aur_gui_results.rc == 0"
      failed_when: false
      when:
        - not (item == 'obs-studio-stable' and obs_studio_q.rc == 0)
        - not (item == 'obs-studio' and obs_studio_stable_q.rc == 0)
        - not (item == 'dotnet-sdk-bin' and dotnet_host_q.rc == 0)
      tags: [gui]

    - name: Summary - skipped GUI AUR due to conflicts
      ansible.builtin.debug:
        msg: "Skipping {{ item }} due to conflict"
      loop: "{{ aur_pkgs_gui }}"
      when:
        - item == 'obs-studio-stable' and obs_studio_q.rc == 0
          or item == 'obs-studio' and obs_studio_stable_q.rc == 0
          or item == 'dotnet-sdk-bin' and dotnet_host_q.rc == 0
      tags: [gui]
