---
- name: Install CLI and GUI packages on Arch
  hosts: all
  become: true
  gather_facts: false

  vars:
    aur_builder: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
    official_pkgs_cli:
      - aichat
      - aircrack-ng
      - ansible
      - archinstall
      - arpwatch
      - atuin
      - autoconf
      - automake
      - azure-cli
      - base-devel
      - bat
      - bind
      - borg
      - borgmatic
      - btop
      - cargo
      - clang
      - clblast
      - cmake
      - composer
      - cronie
      - cryptsetup
      - curl
      - davfs2
      - diffutils
      - diskonaut
      - dnsmasq
      - duf
      - fastfetch
      - fish
      - flatpak
      - flatpak-builder
      - flawfinder
      - flawz
      - fsarchiver
      - fzf
      - gcc
      - gdb
      - git
      - github-cli
      - glances
      - go
      - gpg-tui
      - grim
      - gum
      - hardinfo2
      - htop
      - jq
      - just
      - kismet
      - konsave
      - less
      - llvm
      - lnav
      - ltrace
      - lynis
      - make
      - maven
      - meld
      - meson
      - micro
      - nano
      - nbtscan
      - ncdu
      - netctl
      - nfs-utils
      - ninja
      - nmap
      - nodejs
      - npm
      - openssh
      - pam-u2f
      - paru
      - pavucontrol
      - pcsc-tools
      - perf
      - perl
      - pkg-config
      - podman
      - podman-compose
      - podman-docker
      - promtail
      - pv
      - python
      - python-pip
      - python-pipx
      - python-virtualenv
      - python-yubico
      - ranger
      - reaver
      - ripgrep
      - rsync
      - ruby
      - rust
      - samba
      - sbctl
      - scrcpy
      - screen
      - shellcheck
      - slurp
      - smartmontools
      - snapper
      - sniffnet
      - sshfs
      - starship
      - step-ca
      - step-cli
      - strace
      - sudo
      - tailscale
      - tcpdump
      - tcpflow
      - termshark
      - testdisk
      - tmux
      - trash-cli
      - tree
      - tui-journal
      - ttf-jetbrains-mono-nerd
      - ttf-nerd-fonts-symbols
      - ufw
      - ugrep
      - unrar
      - unzip
      - uv
      - valgrind
      - virt-manager
      - wget
      - which
      - whois
      - wiki-tui
      - wireguard-tools
      - wireshark-cli
      - yarn
      - yq
      - yt-dlp
      - yubico-c-client
      - yubico-pam
      - yubico-piv-tool
      - yubikey-manager
      - yubikey-personalization
      - yubikey-touch-detector
      - zoxide

    aur_pkgs_cli:
      - azcopy
      - bundletool
      - copilot-cli-bin
      - gpart
      - gradle
      - hwinfo
      - lazydocker
      - lazygit
      - linutil-bin
      - metasploit
      - multitail
      - nvtop
      - ocrmypdf
      - ollama-docs
      - ollama-rocm
      - pam-duress
      - pam-gnupg
      - pdf2img-c
      - pdf2png
      - pdf2svg
      - pdfbox
      - pdfcrack
      - pdfgrep
      - pdfutil
      - powershell-bin
      - ssh-manager-tui
      - sshutils
      - stown
      - superfile
      - tuibox
      - tuifimanager
      - tuner
      - veracrypt

    official_pkgs_gui:
      - gimp
      - gparted
      - libreoffice-fresh
      - lmms
      - mousepad
      - mpv
      - obs-studio
      - retroarch
      - shotcut
      - steam
      - vlc
      - vlc-plugins-extra
      - yubikey-personalization-gui

    aur_pkgs_gui:
      - android-file-transfer
      - audacity
      - ausweisapp2
      - brave-beta-bin
      - brave-bin
      - discord
      - digikam
      - dotnet-sdk-8.0
      - dotnet-sdk-bin
      - emudeck
      - filezilla
      - ghostty
      - github-desktop-bin
      - gnac
      - google-chrome
      - impala
      - jellyfin-ffmpeg
      - jellyfin-media-player
      - masterpdfeditor-free
      - microsoft-edge-stable-bin
      - mission-center
      - obs-studio-stable
      - octopi
      - openrgb
      - paperwork
      - pdfarranger
      - php-imagick
      - podman-desktop
      - powershell-editor-services
      - proton-mail-bin
      - proton-pass-bin
      - protonmail-bridge
      - qemu-emulators-full
      - rpi-imager
      - scratch
      - signal-desktop-beta
      - spytrap-adb
      - surge-xt
      - sweethome3d
      - ttf-meslo-nerd-font-powerlevel10k
      - visual-studio-code-bin
      - yubico-authenticator-bin
      - zed

  tasks:
    - name: Ensure base-devel and git are present for AUR work
      community.general.pacman:
        name:
          - base-devel
          - git
        state: present
        extra_args: --needed
      tags: [cli, gui]

    - name: Ensure pacman database is up to date
      community.general.pacman:
        update_cache: true
      tags: [cli, gui]

    - name: Check if paru is installed
      ansible.builtin.command: paru -V
      register: paru_check
      changed_when: false
      failed_when: false
      become: false
      tags: [cli, gui]

    - name: Install paru AUR helper
      when: paru_check.rc != 0
      tags: [cli, gui]
      block:
        - name: Clone paru repository
          ansible.builtin.git:
            repo: https://aur.archlinux.org/paru.git
            dest: /tmp/paru-build
            update: true
            force: true
          become: false
          become_user: "{{ aur_builder }}"

        - name: Build and install paru
          ansible.builtin.command: makepkg -si --noconfirm
          args:
            chdir: /tmp/paru-build
          become: false
          become_user: "{{ aur_builder }}"
          register: paru_makepkg
          changed_when: paru_makepkg.rc == 0
          failed_when: paru_makepkg.rc != 0

    - name: Install CLI official packages
      community.general.pacman:
        name: "{{ item }}"
        state: present
        extra_args: --needed
      loop: "{{ official_pkgs_cli }}"
      tags: [cli]

    - name: Install GUI official packages
      community.general.pacman:
        name: "{{ item }}"
        state: present
        extra_args: --needed
      loop: "{{ official_pkgs_gui }}"
      tags: [gui]

    - name: Check if obs-studio is installed
      ansible.builtin.command: pacman -Q obs-studio
      register: obs_studio_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Check if obs-studio-stable is installed
      ansible.builtin.command: pacman -Q obs-studio-stable
      register: obs_studio_stable_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Check if dotnet-host is installed
      ansible.builtin.command: pacman -Q dotnet-host
      register: dotnet_host_q
      changed_when: false
      failed_when: false
      tags: [gui]

    - name: Install AUR packages (CLI)
      ansible.builtin.command: "paru -S --noconfirm --needed {{ item }}"
      args:
        warn: false
      loop: "{{ aur_pkgs_cli }}"
      register: aur_cli_results
      changed_when: "aur_cli_results.rc == 0"
      failed_when: false
      become: false
      become_user: "{{ aur_builder }}"
      tags: [cli]

    - name: Install AUR packages (GUI)
      ansible.builtin.command: "paru -S --noconfirm --needed {{ item }}"
      args:
        warn: false
      loop: "{{ aur_pkgs_gui }}"
      register: aur_gui_results
      changed_when: "aur_gui_results.rc == 0"
      failed_when: false
      when:
        - not (item == 'obs-studio-stable' and obs_studio_q.rc == 0)
        - not (item == 'obs-studio' and obs_studio_stable_q.rc == 0)
        - not (item == 'dotnet-sdk-bin' and dotnet_host_q.rc == 0)
      become: false
      become_user: "{{ aur_builder }}"
      tags: [gui]

    - name: Summary - skipped GUI AUR due to conflicts
      ansible.builtin.debug:
        msg: "Skipping {{ item }} due to conflict"
      loop: "{{ aur_pkgs_gui }}"
      when:
        - item == 'obs-studio-stable' and obs_studio_q.rc == 0
          or item == 'obs-studio' and obs_studio_stable_q.rc == 0
          or item == 'dotnet-sdk-bin' and dotnet_host_q.rc == 0
      tags: [gui]
